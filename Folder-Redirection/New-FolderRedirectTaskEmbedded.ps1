# Requires -Version 3
<#
    .SYNOPSIS
        Creates a scheduled task to enable folder redirection at user login.
        Enable folder redirection on Windows 10 Azure AD joined PCs.
        Downloads the folder redirection script from a URL locally and creates the schedule task.
#>
[CmdletBinding(ConfirmImpact = 'Low', HelpURI = 'https://stealthpuppy.com/', SupportsPaging = $False,
    SupportsShouldProcess = $False, PositionalBinding = $False)]
Param (
    [Parameter()] $Script = "Redirect-Folders.ps1",
    [Parameter()] $ScriptVb = "Redirect-Folders.vbs",
    [Parameter()] $TaskName = "Folder Redirection",
    [Parameter()] $Group = $((Get-LocalGroup -SID S-1-5-32-545).Name),
    [Parameter()] $Execute = "wscript.exe",
    [Parameter()] $Target = "$env:ProgramData\Intune-Scripts",
    [Parameter()] $Arguments = "$Target\$ScriptVb /b /nologo",
    [Parameter()] $VerbosePreference = "Continue"
)

#Log file
$stampDate = Get-Date
$LogFile = "$env:ProgramData\Intune-PowerShell-Logs\New-FolderRedirectTask-" + $stampDate.ToFileTimeUtc() + ".log"
Start-Transcript -Path $LogFile

# Encoded folder redirection script
$encodedScript = "IwAgAFIAZQBxAHUAaQByAGUAcwAgAC0AVgBlAHIAcwBpAG8AbgAgADMAIAA8ACMAIAAgACAAIAAgAC4AUwBZAE4ATwBQAFMASQBTACAAIAAgACAAIAAgACAAIAAgAEMAcgBlAGEAdABlAHMAIABhACAAcwBjAGgAZQBkAHUAbABlAGQAIAB0AGEAcwBrACAAdABvACAAaQBtAHAAbABlAG0AZQBuAHQAIABmAG8AbABkAGUAcgAgAHIAZQBkAGkAcgBlAGMAdABpAG8AbgAgAGYAbwByAC4AIAAgACAAIAAgACAALgBOAE8AVABFAFMAIAAgACAAIAAgACAAIAAgACAATgBhAG0AZQA6ACAAUgBlAGQAaQByAGUAYwB0AC0ARgBvAGwAZABlAHIAcwAuAHAAcwAxACAAIAAgACAAIAAgACAAIAAgAEEAdQB0AGgAbwByADoAIABBAGEAcgBvAG4AIABQAGEAcgBrAGUAcgAgACMAPgAgAFsAQwBtAGQAbABlAHQAQgBpAG4AZABpAG4AZwAoAEMAbwBuAGYAaQByAG0ASQBtAHAAYQBjAHQAIAA9ACAAJwBMAG8AdwAnACwAIABIAGUAbABwAFUAUgBJACAAPQAgACcAaAB0AHQAcABzADoALwAvAHMAdABlAGEAbAB0AGgAcAB1AHAAcAB5AC4AYwBvAG0ALwAnACwAIABTAHUAcABwAG8AcgB0AHMAUABhAGcAaQBuAGcAIAA9ACAAJABGAGEAbABzAGUALAAgACAAIAAgACAAUwB1AHAAcABvAHIAdABzAFMAaABvAHUAbABkAFAAcgBvAGMAZQBzAHMAIAA9ACAAJABGAGEAbABzAGUALAAgAFAAbwBzAGkAdABpAG8AbgBhAGwAQgBpAG4AZABpAG4AZwAgAD0AIAAkAEYAYQBsAHMAZQApAF0AIABQAGEAcgBhAG0AIAAoACAAIAAgACAAIABbAFAAYQByAGEAbQBlAHQAZQByACgAKQBdACAAJABWAGUAcgBiAG8AcwBlAFAAcgBlAGYAZQByAGUAbgBjAGUAIAA9ACAAIgBDAG8AbgB0AGkAbgB1AGUAIgAgACkAIAAgACMAIABMAG8AZwAgAGYAaQBsAGUAIAAkAHMAdABhAG0AcABEAGEAdABlACAAPQAgAEcAZQB0AC0ARABhAHQAZQAgACQATABvAGcARgBpAGwAZQAgAD0AIAAiACQAZQBuAHYAOgBMAG8AYwBhAGwAQQBwAHAARABhAHQAYQBcAEkAbgB0AHUAbgBlAC0AUABvAHcAZQByAFMAaABlAGwAbAAtAEwAbwBnAHMAXABSAGUAZABpAHIAZQBjAHQALQBGAG8AbABkAGUAcgBzAC0AIgAgACsAIAAkAHMAdABhAG0AcABEAGEAdABlAC4AVABvAEYAaQBsAGUAVABpAG0AZQBVAHQAYwAoACkAIAArACAAIgAuAGwAbwBnACIAIABTAHQAYQByAHQALQBUAHIAYQBuAHMAYwByAGkAcAB0ACAALQBQAGEAdABoACAAJABMAG8AZwBGAGkAbABlACAAIABGAHUAbgBjAHQAaQBvAG4AIABTAGUAdAAtAEsAbgBvAHcAbgBGAG8AbABkAGUAcgBQAGEAdABoACAAewAgACAAIAAgACAAPAAjACAAIAAgACAAIAAgACAAIAAgAC4AUwBZAE4ATwBQAFMASQBTACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAUwBlAHQAcwAgAGEAIABrAG4AbwB3AG4AIABmAG8AbABkAGUAcgAnAHMAIABwAGEAdABoACAAdQBzAGkAbgBnACAAUwBIAFMAZQB0AEsAbgBvAHcAbgBGAG8AbABkAGUAcgBQAGEAdABoAC4AIAAgACAAIAAgACAAIAAgACAALgBQAEEAUgBBAE0ARQBUAEUAUgAgAEsAbgBvAHcAbgBGAG8AbABkAGUAcgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFQAaABlACAAawBuAG8AdwBuACAAZgBvAGwAZABlAHIAIAB3AGgAbwBzAGUAIABwAGEAdABoACAAdABvACAAcwBlAHQALgAgACAAIAAgACAAIAAgACAAIAAuAFAAQQBSAEEATQBFAFQARQBSACAAUABhAHQAaAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFQAaABlACAAdABhAHIAZwBlAHQAIABwAGEAdABoACAAdABvACAAcgBlAGQAaQByAGUAYwB0ACAAdABoAGUAIABmAG8AbABkAGUAcgAgAHQAbwAuACAAIAAgACAAIAAgACAAIAAgAC4ATgBPAFQARQBTACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAARgBvAHIAawBlAGQAIABmAHIAbwBtADoAIABoAHQAdABwAHMAOgAvAC8AZwBpAHMAdAAuAGcAaQB0AGgAdQBiAC4AYwBvAG0ALwBzAGUAbQBlAG4AawBvAC8ANAA5AGEAMgA4ADYANwA1AGUANABhAGEAZQA1AGMAOABiAGUANAA5AGIAOAAzADkANgAwADgANwA3AGEAYwA1ACAAIAAgACAAIAAjAD4AIAAgACAAIAAgAFAAYQByAGEAbQAgACgAIAAgACAAIAAgACAAIAAgACAAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAE0AYQBuAGQAYQB0AG8AcgB5ACAAPQAgACQAdAByAHUAZQApAF0AIAAgACAAIAAgACAAIAAgACAAWwBWAGEAbABpAGQAYQB0AGUAUwBlAHQAKAAnAEMAbwBuAHQAYQBjAHQAcwAnACwAIAAnAEQAZQBzAGsAdABvAHAAJwAsACAAJwBEAG8AYwB1AG0AZQBuAHQAcwAnACwAIAAnAEQAbwB3AG4AbABvAGEAZABzACcALAAgACcARgBhAHYAbwByAGkAdABlAHMAJwAsACAAJwBHAGEAbQBlAHMAJwAsACAAJwBMAGkAbgBrAHMAJwAsACAAIAAnAE0AdQBzAGkAYwAnACwAIAAnAFAAaQBjAHQAdQByAGUAcwAnACwAIAAnAFYAaQBkAGUAbwBzACcALAAgACkAXQAgACAAIAAgACAAIAAgACAAIABbAHMAdAByAGkAbgBnAF0AIAAkAEsAbgBvAHcAbgBGAG8AbABkAGUAcgAsACAAIAAgACAAIAAgACAAIAAgACAAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAE0AYQBuAGQAYQB0AG8AcgB5ACAAPQAgACQAdAByAHUAZQApAF0AIAAgACAAIAAgACAAIAAgACAAWwBzAHQAcgBpAG4AZwBdACAAJABQAGEAdABoACAAIAAgACAAIAApACAAIAAgACAAIAAgACMAIABEAGUAZgBpAG4AZQAgAGsAbgBvAHcAbgAgAGYAbwBsAGQAZQByACAARwBVAEkARABzACAAIAAgACAAIAAkAEsAbgBvAHcAbgBGAG8AbABkAGUAcgBzACAAPQAgAEAAewAgACAAIAAgACAAIAAgACAAIAAnAEMAbwBuAHQAYQBjAHQAcwAnACAAIAAgACAAIAAgACAAPQAgACcANQA2ADcAOAA0ADgANQA0AC0AQwA2AEMAQgAtADQANgAyAGIALQA4ADEANgA5AC0AOAA4AEUAMwA1ADAAQQBDAEIAOAA4ADIAJwA7ACAAIAAgACAAIAAgACAAIAAgACcARABlAHMAawB0AG8AcAAnACAAIAAgACAAIAAgACAAIAA9ACAAQAAoACcAQgA0AEIARgBDAEMAMwBBAC0ARABCADIAQwAtADQAMgA0AEMALQBCADAAMgA5AC0ANwBGAEUAOQA5AEEAOAA3AEMANgA0ADEAJwApADsAIAAgACAAIAAgACAAIAAgACAAJwBEAG8AYwB1AG0AZQBuAHQAcwAnACAAIAAgACAAIAAgAD0AIABAACgAJwBGAEQARAAzADkAQQBEADAALQAyADMAOABGAC0ANAA2AEEARgAtAEEARABCADQALQA2AEMAOAA1ADQAOAAwADMANgA5AEMANwAnACwAIAAnAGYANAAyAGUAZQAyAGQAMwAtADkAMAA5AGYALQA0ADkAMAA3AC0AOAA4ADcAMQAtADQAYwAyADIAZgBjADAAYgBmADcANQA2ACcAKQA7ACAAIAAgACAAIAAgACAAIAAgACcARABvAHcAbgBsAG8AYQBkAHMAJwAgACAAIAAgACAAIAA9ACAAQAAoACcAMwA3ADQARABFADIAOQAwAC0AMQAyADMARgAtADQANQA2ADUALQA5ADEANgA0AC0AMwA5AEMANAA5ADIANQBFADQANgA3AEIAJwAsACAAJwA3AGQAOAAzAGUAZQA5AGIALQAyADIANAA0AC0ANABlADcAMAAtAGIAMQBmADUALQA1ADMAOQAzADAANAAyAGEAZgAxAGUANAAnACkAOwAgACAAIAAgACAAIAAgACAAIAAnAEYAYQB2AG8AcgBpAHQAZQBzACcAIAAgACAAIAAgACAAPQAgACcAMQA3ADcANwBGADcANgAxAC0ANgA4AEEARAAtADQARAA4AEEALQA4ADcAQgBEAC0AMwAwAEIANwA1ADkARgBBADMAMwBEAEQAJwA7ACAAIAAgACAAIAAgACAAIAAgACcARwBhAG0AZQBzACcAIAAgACAAIAAgACAAIAAgACAAIAA9ACAAJwBDAEEAQwA1ADIAQwAxAEEALQBCADUAMwBEAC0ANABlAGQAYwAtADkAMgBEADcALQA2AEIAMgBFADgAQQBDADEAOQA0ADMANAAnADsAIAAgACAAIAAgACAAIAAgACAAJwBMAGkAbgBrAHMAJwAgACAAIAAgACAAIAAgACAAIAAgAD0AIAAnAGIAZgBiADkAZAA1AGUAMAAtAGMANgBhADkALQA0ADAANABjAC0AYgAyAGIAMgAtAGEAZQA2AGQAYgA2AGEAZgA0ADkANgA4ACcAOwAgACAAIAAgACAAIAAgACAAIAAnAE0AdQBzAGkAYwAnACAAIAAgACAAIAAgACAAIAAgACAAPQAgAEAAKAAnADQAQgBEADgARAA1ADcAMQAtADYARAAxADkALQA0ADgARAAzAC0AQgBFADkANwAtADQAMgAyADIAMgAwADAAOAAwAEUANAAzACcALAAgACcAYQAwAGMANgA5AGEAOQA5AC0AMgAxAGMAOAAtADQANgA3ADEALQA4ADcAMAAzAC0ANwA5ADMANAAxADYAMgBmAGMAZgAxAGQAJwApADsAIAAgACAAIAAgACAAIAAgACAAJwBQAGkAYwB0AHUAcgBlAHMAJwAgACAAIAAgACAAIAAgAD0AIABAACgAJwAzADMARQAyADgAMQAzADAALQA0AEUAMQBFAC0ANAA2ADcANgAtADgAMwA1AEEALQA5ADgAMwA5ADUAQwAzAEIAQwAzAEIAQgAnACwAIAAnADAAZABkAGQAMAAxADUAZAAtAGIAMAA2AGMALQA0ADUAZAA1AC0AOABjADQAYwAtAGYANQA5ADcAMQAzADgANQA0ADYAMwA5ACcAKQA7ACAAIAAgACAAIAAgACAAIAAgACcAVgBpAGQAZQBvAHMAJwAgACAAIAAgACAAIAAgACAAIAA9ACAAQAAoACcAMQA4ADkAOAA5AEIAMQBEAC0AOQA5AEIANQAtADQANQA1AEIALQA4ADQAMQBDAC0AQQBCADcAQwA3ADQARQA0AEQARABGAEMAJwAsACAAJwAzADUAMgA4ADYAYQA2ADgALQAzAGMANQA3AC0ANAAxAGEAMQAtAGIAYgBiADEALQAwAGUAYQBlADcAMwBkADcANgBjADkANQAnACkAOwAgACAAIAAgACAAfQAgACAAIAAgACAAIAAjACAARABlAGYAaQBuAGUAIABTAEgAUwBlAHQASwBuAG8AdwBuAEYAbwBsAGQAZQByAFAAYQB0AGgAIABpAGYAIABpAHQAIABoAGEAcwBuACcAdAAgAGIAZQBlAG4AIABkAGUAZgBpAG4AZQBkACAAYQBsAHIAZQBhAGQAeQAgACAAIAAgACAAJABUAHkAcABlACAAPQAgACgAWwBTAHkAcwB0AGUAbQAuAE0AYQBuAGEAZwBlAG0AZQBuAHQALgBBAHUAdABvAG0AYQB0AGkAbwBuAC4AUABTAFQAeQBwAGUATgBhAG0AZQBdACcASwBuAG8AdwBuAEYAbwBsAGQAZQByAHMAJwApAC4AVAB5AHAAZQAgACAAIAAgACAASQBmACAAKAAtAG4AbwB0ACAAJABUAHkAcABlACkAIAB7ACAAIAAgACAAIAAgACAAIAAgACQAUwBpAGcAbgBhAHQAdQByAGUAIAA9ACAAQAAnACAAWwBEAGwAbABJAG0AcABvAHIAdAAoACIAcwBoAGUAbABsADMAMgAuAGQAbABsACIAKQBdACAAcAB1AGIAbABpAGMAIABlAHgAdABlAHIAbgAgAHMAdABhAHQAaQBjACAAaQBuAHQAIABTAEgAUwBlAHQASwBuAG8AdwBuAEYAbwBsAGQAZQByAFAAYQB0AGgAKAByAGUAZgAgAEcAdQBpAGQAIABmAG8AbABkAGUAcgBJAGQALAAgAHUAaQBuAHQAIABmAGwAYQBnAHMALAAgAEkAbgB0AFAAdAByACAAdABvAGsAZQBuACwAIABbAE0AYQByAHMAaABhAGwAQQBzACgAVQBuAG0AYQBuAGEAZwBlAGQAVAB5AHAAZQAuAEwAUABXAFMAdAByACkAXQAgAHMAdAByAGkAbgBnACAAcABhAHQAaAApADsAIAAnAEAAIAAgACAAIAAgACAAIAAgACAAJABUAHkAcABlACAAPQAgAEEAZABkAC0AVAB5AHAAZQAgAC0ATQBlAG0AYgBlAHIARABlAGYAaQBuAGkAdABpAG8AbgAgACQAUwBpAGcAbgBhAHQAdQByAGUAIAAtAE4AYQBtAGUAIAAnAEsAbgBvAHcAbgBGAG8AbABkAGUAcgBzACcAIAAtAE4AYQBtAGUAcwBwAGEAYwBlACAAJwBTAEgAUwBlAHQASwBuAG8AdwBuAEYAbwBsAGQAZQByAFAAYQB0AGgAJwAgAC0AUABhAHMAcwBUAGgAcgB1ACAAIAAgACAAIAB9ACAAIAAgACAAIAAgACMAIABNAGEAawBlACAAcABhAHQAaAAsACAAaQBmACAAZABvAGUAcwBuACcAdAAgAGUAeABpAHMAdAAgACAAIAAgACAASQBmACAAKAAhACgAVABlAHMAdAAtAFAAYQB0AGgAIAAkAFAAYQB0AGgAIAAtAFAAYQB0AGgAVAB5AHAAZQAgAEMAbwBuAHQAYQBpAG4AZQByACkAKQAgAHsAIAAgACAAIAAgACAAIAAgACAATgBlAHcALQBJAHQAZQBtACAALQBQAGEAdABoACAAJABQAGEAdABoACAALQBUAHkAcABlACAARABpAHIAZQBjAHQAbwByAHkAIAAtAEYAbwByAGMAZQAgAC0AVgBlAHIAYgBvAHMAZQAgACAAIAAgACAAfQAgACAAIAAgACAAIAAjACAAVgBhAGwAaQBkAGEAdABlACAAdABoAGUAIABwAGEAdABoACAAIAAgACAAIABJAGYAIAAoAFQAZQBzAHQALQBQAGEAdABoACAAJABQAGEAdABoACAALQBQAGEAdABoAFQAeQBwAGUAIABDAG8AbgB0AGEAaQBuAGUAcgApACAAewAgACAAIAAgACAAIAAgACAAIAAjACAAQwBhAGwAbAAgAFMASABTAGUAdABLAG4AbwB3AG4ARgBvAGwAZABlAHIAUABhAHQAaAAgACAAIAAgACAAIAAgACAAIAAjACAAIAByAGUAdAB1AHIAbgAgACQAVAB5AHAAZQA6ADoAUwBIAFMAZQB0AEsAbgBvAHcAbgBGAG8AbABkAGUAcgBQAGEAdABoACgAWwByAGUAZgBdACQASwBuAG8AdwBuAEYAbwBsAGQAZQByAHMAWwAkAEsAbgBvAHcAbgBGAG8AbABkAGUAcgBdACwAIAAwACwAIAAwACwAIAAkAFAAYQB0AGgAKQAgACAAIAAgACAAIAAgACAAIABGAG8AcgBFAGEAYwBoACAAKAAkAGcAdQBpAGQAIABpAG4AIAAkAEsAbgBvAHcAbgBGAG8AbABkAGUAcgBzAFsAJABLAG4AbwB3AG4ARgBvAGwAZABlAHIAXQApACAAewAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFcAcgBpAHQAZQAtAFYAZQByAGIAbwBzAGUAIAAiAFIAZQBkAGkAcgBlAGMAdABpAG4AZwAgACQASwBuAG8AdwBuAEYAbwBsAGQAZQByAHMAWwAkAEsAbgBvAHcAbgBGAG8AbABkAGUAcgBdACIAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAkAHIAZQBzAHUAbAB0ACAAPQAgACQAVAB5AHAAZQA6ADoAUwBIAFMAZQB0AEsAbgBvAHcAbgBGAG8AbABkAGUAcgBQAGEAdABoACgAWwByAGUAZgBdACQAZwB1AGkAZAAsACAAMAAsACAAMAAsACAAJABQAGEAdABoACkAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIABJAGYAIAAoACQAcgBlAHMAdQBsAHQAIAAtAG4AZQAgADAAKQAgAHsAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACQAZQByAHIAbwByAG0AcwBnACAAPQAgACIARQByAHIAbwByACAAcgBlAGQAaQByAGUAYwB0AGkAbgBnACAAJAAoACQASwBuAG8AdwBuAEYAbwBsAGQAZQByACkALgAgAFIAZQB0AHUAcgBuACAAYwBvAGQAZQAgACQAKAAkAHIAZQBzAHUAbAB0ACkAIAA9ACAAJAAoACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4AQwBvAG0AcABvAG4AZQBuAHQATQBvAGQAZQBsAC4AVwBpAG4AMwAyAEUAeABjAGUAcAB0AGkAbwBuACgAJAByAGUAcwB1AGwAdAApACkALgBtAGUAcwBzAGEAZwBlACkAIgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAVABoAHIAbwB3ACAAJABlAHIAcgBvAHIAbQBzAGcAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAB9ACAAIAAgACAAIAAgACAAIAAgAH0AIAAgACAAIAAgAH0AIAAgACAAIAAgAEUAbABzAGUAIAB7ACAAIAAgACAAIAAgACAAIAAgAFQAaAByAG8AdwAgAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAEQAaQByAGUAYwB0AG8AcgB5AE4AbwB0AEYAbwB1AG4AZABFAHgAYwBlAHAAdABpAG8AbgAgACIAQwBvAHUAbABkACAAbgBvAHQAIABmAGkAbgBkACAAcABhAHIAdAAgAG8AZgAgAHQAaABlACAAcABhAHQAaAAgACQAUABhAHQAaAAuACIAIAAgACAAIAAgAH0AIAAJACAAIAAgACAAIAAjACAARgBpAHgAIAB1AHAAIABwAGUAcgBtAGkAcwBzAGkAbwBuAHMALAAgAGkAZgAgAHcAZQAnAHIAZQAgAHMAdABpAGwAbAAgAGgAZQByAGUAIAAgACAAIAAgAEEAdAB0AHIAaQBiACAAKwByACAAJABQAGEAdABoACAAIAAgACAAIABXAHIAaQB0AGUALQBPAHUAdABwAHUAdAAgACQAUABhAHQAaAAgAH0AIAAgAEYAdQBuAGMAdABpAG8AbgAgAEcAZQB0AC0ASwBuAG8AdwBuAEYAbwBsAGQAZQByAFAAYQB0AGgAIAB7ACAAIAAgACAAIAA8ACMAIAAgACAAIAAgACAAIAAgACAALgBTAFkATgBPAFAAUwBJAFMAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIABHAGUAdABzACAAYQAgAGsAbgBvAHcAbgAgAGYAbwBsAGQAZQByACcAcwAgAHAAYQB0AGgAIAB1AHMAaQBuAGcAIABHAGUAdABGAG8AbABkAGUAcgBQAGEAdABoAC4AIAAgACAAIAAgACAAIAAgACAALgBQAEEAUgBBAE0ARQBUAEUAUgAgAEsAbgBvAHcAbgBGAG8AbABkAGUAcgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFQAaABlACAAawBuAG8AdwBuACAAZgBvAGwAZABlAHIAIAB3AGgAbwBzAGUAIABwAGEAdABoACAAdABvACAAZwBlAHQALgAgAFYAYQBsAGkAZABhAHQAZQBzACAAcwBlAHQAIAB0AG8AIABlAG4AcwB1AHIAZQAgAG8AbgBsAHkAIABrAG4AdwB3AG4AIABmAG8AbABkAGUAcgBzACAAYQByAGUAIABwAGEAcwBzAGUAZAAuACAAIAAgACAAIAAgACAAIAAgAC4ATgBPAFQARQBTACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAaAB0AHQAcABzADoALwAvAHMAdABhAGMAawBvAHYAZQByAGYAbABvAHcALgBjAG8AbQAvAHEAdQBlAHMAdABpAG8AbgBzAC8AMQA2ADYANQA4ADAAMQA1AC8AaABvAHcALQBjAGEAbgAtAGkALQB1AHMAZQAtAHAAbwB3AGUAcgBzAGgAZQBsAGwALQB0AG8ALQBjAGEAbABsAC0AcwBoAGcAZQB0AGsAbgBvAHcAbgBmAG8AbABkAGUAcgBwAGEAdABoACAAIAAgACAAIAAjAD4AIAAgACAAIAAgAFAAYQByAGEAbQAgACgAIAAgACAAIAAgACAAIAAgACAAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAE0AYQBuAGQAYQB0AG8AcgB5ACAAPQAgACQAdAByAHUAZQApAF0AIAAgACAAIAAgACAAIAAgACAAWwBWAGEAbABpAGQAYQB0AGUAUwBlAHQAKAAnAEMAbwBuAHQAYQBjAHQAcwAnACwAIAAnAEQAZQBzAGsAdABvAHAAJwAsACAAJwBEAG8AYwB1AG0AZQBuAHQAcwAnACwAIAAnAEQAbwB3AG4AbABvAGEAZABzACcALAAgACcARgBhAHYAbwByAGkAdABlAHMAJwAsACAAJwBHAGEAbQBlAHMAJwAsACAAJwBMAGkAbgBrAHMAJwAsACAAIAAnAE0AdQBzAGkAYwAnACwAIAAnAFAAaQBjAHQAdQByAGUAcwAnACwAIAAnAFYAaQBkAGUAbwBzACcALAAgACkAXQAgACAAIAAgACAAIAAgACAAIABbAHMAdAByAGkAbgBnAF0AIAAkAEsAbgBvAHcAbgBGAG8AbABkAGUAcgAgACAAIAAgACAAKQAgACAAIAAgACAAVwByAGkAdABlAC0ATwB1AHQAcAB1AHQAIABbAEUAbgB2AGkAcgBvAG4AbQBlAG4AdABdADoAOgBHAGUAdABGAG8AbABkAGUAcgBQAGEAdABoACgAJABLAG4AbwB3AG4ARgBvAGwAZABlAHIAKQAgAH0AIAAgAEYAdQBuAGMAdABpAG8AbgAgAE0AbwB2AGUALQBGAGkAbABlAHMAIAB7ACAAIAAgACAAIAA8ACMAIAAgACAAIAAgACAAIAAgACAALgBTAFkATgBPAFAAUwBJAFMAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIABNAG8AdgBlAHMAIABjAG8AbgB0AGUAbgB0AHMAIABvAGYAIABhACAAZgBvAGwAZABlAHIAIAB3AGkAdABoACAAbwB1AHQAcAB1AHQAIAB0AG8AIABhACAAbABvAGcALgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFUAcwBlAHMAIABSAG8AYgBvAGMAbwBwAHkAIAB0AG8AIABlAG4AcwB1AHIAZQAgAGQAYQB0AGEAIABpAG4AdABlAGcAcgBpAHQAeQAgAGEAbgBkACAAYQBsAGwAIABtAG8AdgBlAHMAIABhAHIAZQAgAGwAbwBnAGcAZQBkACAAZgBvAHIAIABhAHUAZABpAHQAaQBuAGcALgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAE0AZQBhAG4AcwAgAHcAZQAgAGQAbwBuACcAdAAgAG4AZQBlAGQAIAB0AG8AIAByAGUALQB3AHIAaQB0AGUAIABmAHUAbgBjAHQAaQBvAG4AYQBsAGkAdAB5ACAAaQBuACAAUABvAHcAZQByAFMAaABlAGwAbAAuACAAIAAgACAAIAAgACAAIAAgAC4AUABBAFIAQQBNAEUAVABFAFIAIABTAG8AdQByAGMAZQAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFQAaABlACAAcwBvAHUAcgBjAGUAIABmAG8AbABkAGUAcgAuACAAIAAgACAAIAAgACAAIAAgAC4AUABBAFIAQQBNAEUAVABFAFIAIABEAGUAcwB0AGkAbgBhAHQAaQBvAG4AIAAgACAAIAAgACAAIAAgACAAIAAgACAAIABUAGgAZQAgAGQAZQBzAHQAaQBuAGEAdABpAG8AbgAgAGwAbwBnAC4AIAAgACAAIAAgACAAIAAgACAALgBQAEEAUgBBAE0ARQBUAEUAUgAgAEwAbwBnACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAVABoAGUAIABsAG8AZwAgAGYAaQBsAGUAIAB0AG8AIABzAHQAbwByAGUAIABwAHIAbwBnAHIAZQBzAHMALwBvAHUAdABwAHUAdAAgACAAIAAgACAAIwA+ACAAIAAgACAAIABQAGEAcgBhAG0AIAAoACAAIAAgACAAIAAgACAAIAAgACQAUwBvAHUAcgBjAGUALAAgACAAIAAgACAAIAAgACAAIAAkAEQAZQBzAHQAaQBuAGEAdABpAG8AbgAsACAAIAAgACAAIAAgACAAIAAgACQATABvAGcAIAAgACAAIAAgACkAIAAgACAAIAAgAEkAZgAgACgAIQAoAFQAZQBzAHQALQBQAGEAdABoACAAKABTAHAAbABpAHQALQBQAGEAdABoACAAJABMAG8AZwApACkAKQAgAHsAIABOAGUAdwAtAEkAdABlAG0AIAAtAFAAYQB0AGgAIAAoAFMAcABsAGkAdAAtAFAAYQB0AGgAIAAkAEwAbwBnACkAIAAtAEkAdABlAG0AVAB5AHAAZQAgAEMAbwBuAHQAYQBpAG4AZQByACAAfQAgACAAIAAgACAAVwByAGkAdABlAC0AVgBlAHIAYgBvAHMAZQAgACIATQBvAHYAaQBuAGcAIABkAGEAdABhACAAaQBuACAAZgBvAGwAZABlAHIAIAAkAFMAbwB1AHIAYwBlACAAdABvACAAJABEAGUAcwB0AGkAbgBhAHQAaQBvAG4ALgAiACAAIAAgACAAIABSAG8AYgBvAGMAbwBwAHkALgBlAHgAZQAgACIAJABTAG8AdQByAGMAZQAiACAAIgAkAEQAZQBzAHQAaQBuAGEAdABpAG8AbgAiACAALwBFACAALwBNAE8AVgAgAC8AWABKACAALwBYAEYAIAAqAC4AaQBuAGkAIAAvAFIAOgAxACAALwBXADoAMQAgAC8ATgBQACAALwBMAE8ARwArADoAJABMAG8AZwAgAH0AIAAgAEYAdQBuAGMAdABpAG8AbgAgAFIAZQBkAGkAcgBlAGMAdAAtAEYAbwBsAGQAZQByACAAewAgACAAIAAgACAAPAAjACAAIAAgACAAIAAgACAAIAAgAC4AUwBZAE4ATwBQAFMASQBTACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAARgB1AG4AYwB0AGkAbwBuACAAZQB4AGkAcwB0AHMAIAB0AG8AIAByAGUAZAB1AGMAZQAgAGMAbwBkAGUAIAByAGUAcQB1AGkAcgBlAGQAIAB0AG8AIAByAGUAZABpAHIAZQBjAHQAIABlAGEAYwBoACAAZgBvAGwAZABlAHIALgAgACAAIAAgACAAIwA+ACAAIAAgACAAIABQAGEAcgBhAG0AIAAoACAAIAAgACAAIAAgACAAIAAgAFsAUABhAHIAYQBtAGUAdABlAHIAKABNAGEAbgBkAGEAdABvAHIAeQAgAD0AIAAkAHQAcgB1AGUAKQBdACAAIAAgACAAIAAgACAAIAAgAFsAcwB0AHIAaQBuAGcAXQAgACQAUwB5AG4AYwBGAG8AbABkAGUAcgAsACAAIAAgACAAIAAgACAAIAAgACAAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAE0AYQBuAGQAYQB0AG8AcgB5ACAAPQAgACQAdAByAHUAZQApAF0AIAAgACAAIAAgACAAIAAgACAAWwBzAHQAcgBpAG4AZwBdACAAJABHAGUAdABGAG8AbABkAGUAcgAsACAAIAAgACAAIAAgACAAIAAgACAAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAE0AYQBuAGQAYQB0AG8AcgB5ACAAPQAgACQAdAByAHUAZQApAF0AIAAgACAAIAAgACAAIAAgACAAWwBzAHQAcgBpAG4AZwBdACAAJABTAGUAdABGAG8AbABkAGUAcgAsACAAIAAgACAAIAAgACAAIAAgACAAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAE0AYQBuAGQAYQB0AG8AcgB5ACAAPQAgACQAdAByAHUAZQApAF0AIAAgACAAIAAgACAAIAAgACAAWwBzAHQAcgBpAG4AZwBdACAAJABUAGEAcgBnAGUAdAAgACAAIAAgACAAKQAgACAAIAAgACAAIAAjACAARwBlAHQAIABjAHUAcgByAGUAbgB0ACAASwBuAG8AdwBuACAAZgBvAGwAZABlAHIAIABwAGEAdABoACAAIAAgACAAIAAkAEYAbwBsAGQAZQByACAAPQAgAEcAZQB0AC0ASwBuAG8AdwBuAEYAbwBsAGQAZQByAFAAYQB0AGgAIAAtAEsAbgBvAHcAbgBGAG8AbABkAGUAcgAgACQARwBlAHQARgBvAGwAZABlAHIAIAAgACAAIAAgACAAIwAgAEkAZgAgAHAAYQB0AGgAcwAgAGQAbwBuACcAdAAgAG0AYQB0AGMAaAAsACAAcgBlAGQAaQByAGUAYwB0ACAAdABoAGUAIABmAG8AbABkAGUAcgAgACAAIAAgACAASQBmACAAKAAkAEYAbwBsAGQAZQByACAALQBuAGUAIAAiACQAUwB5AG4AYwBGAG8AbABkAGUAcgBcACQAVABhAHIAZwBlAHQAIgApACAAewAgACAAIAAgACAAIAAgACAAIAAjACAAUgBlAGQAaQByAGUAYwB0ACAAdABoAGUAIABmAG8AbABkAGUAcgAgACAAIAAgACAAIAAgACAAIABXAHIAaQB0AGUALQBWAGUAcgBiAG8AcwBlACAAIgBSAGUAZABpAHIAZQBjAHQAaQBuAGcAIAAkAFMAZQB0AEYAbwBsAGQAZQByACAAdABvACAAJABTAHkAbgBjAEYAbwBsAGQAZQByAFwAJABUAGEAcgBnAGUAdAAiACAAIAAgACAAIAAgACAAIAAgAFMAZQB0AC0ASwBuAG8AdwBuAEYAbwBsAGQAZQByAFAAYQB0AGgAIAAtAEsAbgBvAHcAbgBGAG8AbABkAGUAcgAgACQAUwBlAHQARgBvAGwAZABlAHIAIAAtAFAAYQB0AGgAIAAiACQAUwB5AG4AYwBGAG8AbABkAGUAcgBcACQAVABhAHIAZwBlAHQAIgAgACAAIAAgACAAIAAgACAAIAAgACMAIABNAG8AdgBlACAAZgBpAGwAZQBzAC8AZgBvAGwAZABlAHIAcwAgAGkAbgB0AG8AIAB0AGgAZQAgAHIAZQBkAGkAcgBlAGMAdABlAGQAIABmAG8AbABkAGUAcgAgACAAIAAgACAAIAAgACAAIABXAHIAaQB0AGUALQBWAGUAcgBiAG8AcwBlACAAIgBNAG8AdgBpAG4AZwAgAGQAYQB0AGEAIABmAHIAbwBtACAAJABTAGUAdABGAG8AbABkAGUAcgAgAHQAbwAgACQAUwB5AG4AYwBGAG8AbABkAGUAcgBcACQAVABhAHIAZwBlAHQAIgAgACAAIAAgACAAIAAgACAAIABNAG8AdgBlAC0ARgBpAGwAZQBzACAALQBTAG8AdQByAGMAZQAgACQARgBvAGwAZABlAHIAIAAtAEQAZQBzAHQAaQBuAGEAdABpAG8AbgAgACIAJABTAHkAbgBjAEYAbwBsAGQAZQByAFwAJABUAGEAcgBnAGUAdAAiACAALQBMAG8AZwAgACIAJABlAG4AdgA6AEwAbwBjAGEAbABBAHAAcABEAGEAdABhAFwAUgBlAGQAaQByAGUAYwB0AEwAbwBnAHMAXABSAG8AYgBvAGMAbwBwAHkAJABUAGEAcgBnAGUAdAAuAGwAbwBnACIAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIwAgAEgAaQBkAGUAIAB0AGgAZQAgAHMAbwB1AHIAYwBlACAAZgBvAGwAZABlAHIAIAAoAHIAYQB0AGgAZQByACAAdABoAGEAbgAgAGQAZQBsAGUAdABlACAAaQB0ACkAIAAgACAAIAAgACAAIAAgACAAQQB0AHQAcgBpAGIAIAArAGgAIAAkAEYAbwBsAGQAZQByACAAIAAgACAAIAB9ACAAIAAgACAAIABFAGwAcwBlACAAewAgACAAIAAgACAAIAAgACAAIABXAHIAaQB0AGUALQBWAGUAcgBiAG8AcwBlACAAIgBGAG8AbABkAGUAcgAgACQARwBlAHQARgBvAGwAZABlAHIAIABtAGEAdABjAGgAZQBzACAAdABhAHIAZwBlAHQALgAgAFMAawBpAHAAcABpAG4AZwAgAHIAZQBkAGkAcgBlAGMAdABpAG8AbgAuACIAIAAgACAAIAAgAH0AIAB9ACAAIAAjACAARwBlAHQAIABPAG4AZQBEAHIAaQB2AGUAIABzAHkAbgBjACAAZgBvAGwAZABlAHIAIAAkAFMAeQBuAGMARgBvAGwAZABlAHIAIAA9ACAARwBlAHQALQBJAHQAZQBtAFAAcgBvAHAAZQByAHQAeQBWAGEAbAB1AGUAIAAtAFAAYQB0AGgAIAAnAEgASwBDAFUAOgBcAFMAbwBmAHQAdwBhAHIAZQBcAE0AaQBjAHIAbwBzAG8AZgB0AFwATwBuAGUARAByAGkAdgBlAFwAQQBjAGMAbwB1AG4AdABzAFwAQgB1AHMAaQBuAGUAcwBzADEAJwAgAC0ATgBhAG0AZQAgACcAVQBzAGUAcgBGAG8AbABkAGUAcgAnACAAVwByAGkAdABlAC0AVgBlAHIAYgBvAHMAZQAgACIAVABhAHIAZwBlAHQAIABzAHkAbgBjACAAZgBvAGwAZABlAHIAIABpAHMAIAAkAFMAeQBuAGMARgBvAGwAZABlAHIALgAiACAAIAAjACAAUgBlAGQAaQByAGUAYwB0ACAAcwBlAGwAZQBjAHQAIABmAG8AbABkAGUAcgBzACAASQBmACAAKABUAGUAcwB0AC0AUABhAHQAaAAgACQAUwB5AG4AYwBGAG8AbABkAGUAcgApACAAewAgACAAIAAgACAAUgBlAGQAaQByAGUAYwB0AC0ARgBvAGwAZABlAHIAIAAtAFMAeQBuAGMARgBvAGwAZABlAHIAIAAkAFMAeQBuAGMARgBvAGwAZABlAHIAIAAtAEcAZQB0AEYAbwBsAGQAZQByACAAJwBGAGEAdgBvAHIAaQB0AGUAcwAnACAALQBTAGUAdABGAG8AbABkAGUAcgAgACcARgBhAHYAbwByAGkAdABlAHMAJwAgAC0AVABhAHIAZwBlAHQAIAAnAEYAYQB2AG8AcgBpAHQAZQBzACcAIAB9ACAARQBsAHMAZQAgAHsAIAAgACAAIAAgAFcAcgBpAHQAZQAtAFYAZQByAGIAbwBzAGUAIAAiACQAUwB5AG4AYwBGAG8AbABkAGUAcgAgAGQAbwBlAHMAIABuAG8AdAAgACgAeQBlAHQAKQAgAGUAeABpAHMAdAAuACAAUwBrAGkAcABwAGkAbgBnACAAZgBvAGwAZABlAHIAIAByAGUAZABpAHIAZQBjAHQAaQBvAG4AIAB1AG4AdABpAGwAIABuAGUAeAB0ACAAbABvAGcAbwBuAC4AIgAgAH0AIAAgAFMAdABvAHAALQBUAHIAYQBuAHMAYwByAGkAcAB0ACAALQBWAGUAcgBiAG8AcwBlAA=="

# Construct string to output as a VBscript
$vbScript = 'Set objShell=CreateObject("WScript.Shell")' + "`r`n"
$vbScript = $vbScript + 'Set objFSO=CreateObject("Scripting.FileSystemObject")' + "`r`n"
$vbScript = $vbScript + 'strCMD = "powershell -ExecutionPolicy Bypass -NonInteractive -WindowStyle Hidden -File ' + "$Target\$Script" + '"' + "`r`n"
$vbScript = $vbScript + 'objShell.Run strCMD,0'

# If local path for script doesn't exist, create it
If (!(Test-Path -Path $Target)) { 
    Write-Verbose "Creating $Target."
    New-Item -Path $Target -Type Directory -Force
}

# Output folder redirection script
Write-Verbose "Outputting encoded script to $Target\$Script."
Remove-Item -Path "$Target\$Script" -Force -ErrorAction SilentlyContinue
$decodedText = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($encodedScript))
$decodedText | Out-File -FilePath "$Target\$Script" -Force

# Output VBscript
Remove-Item -Path "$Target\$VbScript" -Force -ErrorAction SilentlyContinue
$vbScript | Out-File -FilePath "$Target\$ScriptVb" -Force -Encoding ascii

# Get an existing local task if it exists
If ($Task = Get-ScheduledTask -TaskName $TaskName -ErrorAction SilentlyContinue ) { 

    Write-Verbose "Folder redirection task exists."
    # If the task Action differs from what we have above, update the values and save the task
    If (!( ($Task.Actions[0].Execute -eq $Execute) -and ($Task.Actions[0].Arguments -eq $Arguments) )) {
        Write-Verbose "Updating scheduled task."
        $Task.Actions[0].Execute = $Execute
        $Task.Actions[0].Arguments = $Arguments
        $Task | Set-ScheduledTask -Verbose
    }
    Else {
        Write-Verbose "Existing task action is OK, no change required."
    }
}
Else {
    Write-Verbose "Creating folder redirection scheduled task."
    # Build a new task object
    $action = New-ScheduledTaskAction -Execute $Execute -Argument $Arguments
    $trigger = New-ScheduledTaskTrigger -AtLogon -RandomDelay (New-TimeSpan -Minutes 1)
    $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -Hidden -DontStopIfGoingOnBatteries -Compatibility Win8
    $principal = New-ScheduledTaskPrincipal -GroupId $Group
    $newTask = New-ScheduledTask -Action $action -Trigger $trigger -Settings $settings -Principal $principal

    # No task object exists, so register the new task
    Write-Verbose "Registering new task $TaskName."
    Register-ScheduledTask -InputObject $newTask -TaskName $TaskName -Verbose
}

Stop-Transcript
